---
type CopyClipboard = {
	className?: string;
	onCopy?: (text: string | undefined, result: boolean) => void;
};

const { className, onCopy } = Astro.props as CopyClipboard;
---

<clipboard-copy
	class:list={[
		'text-white transition duration-100 ease-linear hover:text-red-500 data-[copied]:text-green-500',
		className,
	]}
	onCopy={onCopy}
>
	<slot />
</clipboard-copy>

<script>
	class ClipboardCopy extends HTMLElement {
		options?: { debug: boolean; message: string; format: string };
		onCopy?: ((text: string | undefined, result: boolean) => void) | undefined;
		constructor() {
			super();

			this.options = this.parseInput(this.getAttribute('options') || '{}');

			this.onCopy = this.getAttribute('onCopy')
				? eval(`(${this.getAttribute('onCopy')})`)
				: undefined;

			this.addEventListener('click', async () => {
				const pre = this.closest(':has(pre)')?.querySelector('pre');
				if (pre && pre.textContent) {
					await navigator.clipboard.writeText(pre.textContent);
					this.setCopy();
				} else {
					console.error('No pre found for clipboard-copy', this, pre);
					throw new Error('No pre found for clipboard-copy');
				}
			});
		}

		setCopy() {
			this.dataset.copied = 'true';
			setTimeout(() => {
				delete this.dataset.copied;
			}, 3000);
		}

		parseInput(input: string) {
			return JSON.parse(input);
		}

		toggleClassNames(classesToRemove: string[], classesToAdd: string[]) {
			this.classList.remove(...classesToRemove);
			this.classList.add(...classesToAdd);
		}

		attributeChangedCallback(name: string, _: any, newValue: any) {
			if (name === 'options') {
				this.options = JSON.parse(newValue || '{}');
			} else if (name === 'onCopy') {
				this.onCopy = newValue ? eval(`(${newValue})`) : undefined;
			}
		}

		static get observedAttributes() {
			return ['options', 'onCopy'];
		}
	}

	customElements.define('clipboard-copy', ClipboardCopy);
</script>
